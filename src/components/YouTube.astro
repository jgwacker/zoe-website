---
/** Props:
 *  - id      (string)   YouTube video ID, e.g. "BZf3GbDg6w4"
 *  - title   (string)   Accessible title for the iframe
 *  - caption (string)   Visible caption under the video
 *  - start   (number?)  Optional start time in seconds (e.g., 3233)
 *  - t       (string?)  Optional human time like "53:53" or "1:02:15"
 */
interface Props {
  id: string;
  title: string;
  caption?: string;
  start?: number;
  t?: string;
}

function parseTimeToSeconds(t?: string): number | undefined {
  if (!t) return undefined;
  // Accept "MM:SS" or "HH:MM:SS" (extra spaces tolerated)
  const parts = t.trim().split(':').map((p) => p.trim());
  if (parts.some((p) => p === '' || isNaN(Number(p)))) return undefined;
  const nums = parts.map(Number);
  if (nums.length === 2) {
    const [mm, ss] = nums;
    return mm * 60 + ss;
  } else if (nums.length === 3) {
    const [hh, mm, ss] = nums;
    return hh * 3600 + mm * 60 + ss;
  }
  return undefined;
}

const { id, title, caption = '', start, t } = Astro.props as Props;

const parsed = parseTimeToSeconds(t);
const startSec =
  typeof start === 'number' && start >= 0
    ? Math.floor(start)
    : (parsed !== undefined ? Math.max(0, Math.floor(parsed)) : undefined);

const params = new URLSearchParams({
  rel: '0',
  modestbranding: '1',
  playsinline: '1',
  ...(startSec !== undefined ? { start: String(startSec) } : {})
});

const embedUrl = `https://www.youtube-nocookie.com/embed/${id}?${params.toString()}`;
const captionId = `yt-${id}-caption`;
---

<figure class="yt-embed">
  <div class="frame">
    <iframe
      src={embedUrl}
      title={title}
      aria-describedby={caption ? captionId : undefined}
      loading="lazy"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen
    ></iframe>
  </div>
  {caption && <figcaption id={captionId}>{caption}</figcaption>}
</figure>

<style>
  .yt-embed .frame {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
  }
  .yt-embed .frame iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
    display: block;
  }
</style>
